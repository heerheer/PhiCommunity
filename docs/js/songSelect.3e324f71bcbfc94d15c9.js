(()=>{"use strict";var e={7153:(e,t,o)=>{e.exports=o.p+"assets/Start.8240.mp3"},6339:(e,t,o)=>{e.exports=o.p+"assets/selectSongItem.7cc8.mp3"}},t={};function o(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e+"../"})(),(()=>{const e={ez:0,hd:1,in:2,at:3};var t=o(6339);function n(){return{createDB:function(e,t,o){return new Promise((function(n,r){const i=indexedDB.open(e);i.onerror=e=>{r({result:"failed",e,request:i})},i.onupgradeneeded=r=>{const i=r.target.result,c=i.createObjectStore(e,{keyPath:t});c.createIndex(t,t,{unique:!0}),o.forEach((e=>{c.createIndex(e,e,{unique:!1})})),n({result:"success",database:i,objectStore:c})}}))},openDB:function(e){return new Promise((function(t,o){const n=indexedDB.open(e);n.onerror=e=>{console.error(e),o({result:"failed",e,request:n})},n.onsuccess=r=>{if(!r.target.result.objectStoreNames.contains(e))return r.target.result.close(),indexedDB.deleteDatabase(e),void o({result:"failed",e:r,request:n});const i=r.target.result;var c=i.transaction([e],"readwrite").objectStore(e);t({result:"success",database:i,objectStore:c})}}))},readAllKeys:function(e){return new Promise((t=>{const o=e.getAllKeys();o.onsuccess=function(n){const r=n.target.result,i=new Array;r.forEach(((n,c)=>{e.get(n).onsuccess=function(n){i.push(n.target.result),c==r.length-1&&t({result:"success",data:i,objectStore:e,request:o,e:n})}}))}}))},readKey:function(e,t){return new Promise(((o,n)=>{var r=e.get(t);r.onerror=t=>{n({result:"failed",objectStore:e,request:r,e:t})},r.onsuccess=t=>{o(r.result),o({result:"success",value:r.result,objectStore:e,request:r,e:t})}}))},updateKey:function(e,t){return new Promise(((o,n)=>{var r=e.put(t);r.onsuccess=function(){o({result:"success",objectStore:e,request:r})},r.onerror=function(){n({result:"failed",objectStore:e,request:r})}}))},createKey:function(e,t){return new Promise((function(o,n){var r=e.add(t);r.onsuccess=function(){o({result:"success",objectStore:e,request:r})},r.onerror=function(){n({result:"failed",objectStore:e,request:r})}}))}}}function r(t,o,n,{level:r,onClick:i}){const c=document.createElement("div");c.classList.add("songItemContainer");const a=function(e,t){const o=document.createElement("div");return o.classList.add("songItem"),o.setAttribute("data-artist",e.artist),o.setAttribute("data-codename",t),o.innerText=e.name,o}(o,n),s=function(e,t="ez"){const o=document.createElement("div");return o.classList.add("level"),n(t),{element:o,switchLevel:n};function n(t){o.classList.remove("ez","hd","in","at"),o.classList.add(t),o.setAttribute("data-level",Math.floor(e[t+"Ranking"]||e.ezRanking||e.hdRanking||e.inRanking||e.atRanking||0))}}(o,r);return c.appendChild(a),c.appendChild(s.element),c.addEventListener("click",(()=>i(t))),{element:c,songMeta:o,codename:n,select:()=>{a.classList.add("selected"),c.classList.add("selected");for(const t in e)document.querySelector(`div.levelItem.${t}`).classList.remove("disabled"),null==o["chart"+t.toUpperCase()]&&(document.querySelector(`div.levelItem.${t}`).classList.add("disabled"),document.querySelector(`div.levelItem.${t}`).classList.remove("selected")),document.querySelector(`div.levelItem.${t}`).setAttribute("data-level",Math.floor(o[t+"Ranking"]||o.ezRanking||o.hdRanking||o.inRanking||o.atRanking||0))},unSelect:()=>{a.classList.remove("selected"),c.classList.remove("selected")},switchLevel:s.switchLevel}}var i=o(7153);const c=function({defaultLevel:o="ez"}){const i=document.createElement("div");i.id="songList",i.classList.add("songList");const c=[];let a,s=o;return{element:i,items:c,createSong:function(e,t,o){const n=new r(c.length,t,o,{onClick:l,level:s});i.appendChild(n.element),c[e]=n},switchSong:l,switchLevel:d,setOrder:function(e){switch(e){case"level":u(((e,t)=>e.songMeta[`${s}Ranking`]<t.songMeta[`${s}Ranking`]?1:-1));break;case"name":u(((e,t)=>e.songMeta.name>t.songMeta.name?1:-1));break;default:c.forEach((({element:e})=>e.style.order=""))}}};function l(o){if(o===a)return;document.querySelector("#loadingBar").classList.remove("hidden"),fetch(t).then((e=>e.arrayBuffer())).then((e=>{const t=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);t.decodeAudioData(e,(function(e){var o=t.createBufferSource();o.buffer=e,o.loop=!1,o.connect(t.destination),o.start(0)}))})),n().openDB("PhiCommunityPlayResults").then((e=>{n().readKey(e.objectStore,window.songMetaList[o].codename+"-"+s).then((e=>{const t=e||{score:0,accuracy:0};document.querySelector("#rightArea > div.detailBar.unplayed > div.score").innerText=Math.round(t.score).toString().padStart(7,"0"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").setAttribute("data-acc",(100*t.accuracy).toFixed(2)+"%"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").classList.remove("unplayed")}))})),void 0!==a&&c[a].unSelect(),i.classList.selected||i.classList.add("selected"),c[o].select(),console.log("Song",o,"Selected");const{songMeta:r,codename:l}=c[o];for(var u=window.levelSelected||["ez"];null==r["chart"+u[0].toUpperCase()];){var m=e[u[0]]+1;4==m&&(m=0);var w=Object.keys(e)[m];console.log("Chart of level",u[0],"is NULL! Switching to next level: ",w),document.querySelector(`div.levelItem.${u[0]}`).classList.add("disabled"),document.querySelector(`div.levelItem.${u[0]}`).classList.remove("selected"),d(w.match(w)),document.querySelector(`div.levelItem.${w}`).classList.add("selected"),document.querySelectorAll("#songList > div.songItemContainer.selected > div.level").forEach((e=>{e.classList.remove(u[0]),e.classList.add(w)})),u=[w]}fetch(`https://heerheer.github.io/PhiCommunity-Charts-Repo/${l}/${r.illustration}`).then((e=>e.blob())).then((e=>{const t=URL.createObjectURL(e);document.children[0].setAttribute("style",`--background: url(${t});`),document.querySelector("img.illustration").src=t})).catch((e=>{console.err("获取曲绘失败!",`url: https://heerheer.github.io/PhiCommunity-Charts-Repo/${l}/${r.illustration}`,e)})),fetch(`https://heerheer.github.io/PhiCommunity-Charts-Repo/${l}/${r.musicFile}`).then((e=>e.blob())).then((e=>{const t=URL.createObjectURL(e);try{window.playSongXHRObj.abort()}catch(e){}fetch(t).then((e=>e.arrayBuffer())).then((e=>{const t=window.slicesAudioContext.createGain();window.slicesAudioContext.decodeAudioData(e,(function(e){try{window.sliceAudioContextSource.stop()}catch(e){}window.sliceAudioContextSource=window.slicesAudioContext.createBufferSource(),window.sliceAudioContextSource.buffer=e,window.sliceAudioContextSource.connect(t),t.connect(window.slicesAudioContext.destination),window.sliceAudioContextSource.start(0,r.sliceAudioStart),t.gain.setValueAtTime(.01,window.slicesAudioContext.currentTime),t.gain.linearRampToValueAtTime(1,window.slicesAudioContext.currentTime+1),clearInterval(window.sliceAudioInterval),window.sliceAudioInterval=setInterval((()=>{t.gain.linearRampToValueAtTime(.01,window.slicesAudioContext.currentTime+1),setTimeout((()=>{window.sliceAudioContextSource.stop(),window.sliceAudioContextSource=window.slicesAudioContext.createBufferSource(),window.sliceAudioContextSource.buffer=e,window.sliceAudioContextSource.connect(t),window.sliceAudioContextSource.start(0,r.sliceAudioStart),t.gain.linearRampToValueAtTime(1,window.slicesAudioContext.currentTime+1)}),500)}),15e3)})),document.querySelector("#loadingBar").classList.add("hidden")}))})).catch((e=>{console.err("获取歌曲失败!",`url: https://heerheer.github.io/PhiCommunity-Charts-Repo/${l}/${r.musicFile}`,e)})),a=o}function d(e){if(s===e)return;window.levelSelected=e,c.forEach((({switchLevel:t})=>t(e))),s=e;const t=document.querySelector("div.songItem.selected").getAttribute("data-codename");n().openDB("PhiCommunityPlayResults").then((e=>{n().readKey(e.objectStore,t+"-"+s).then((e=>{const t=e||{score:0,accuracy:0};document.querySelector("#rightArea > div.detailBar.unplayed > div.score").innerText=Math.round(t.score).toString().padStart(7,"0"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").setAttribute("data-acc",(100*t.accuracy).toFixed(2)+"%"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").classList.remove("unplayed")}))}))}function u(e){[...c].sort(((t,o)=>e(t,o))).forEach((({element:e},t)=>{e.style.order=t}))}}({defaultLevel:"ez"});function a(e){const t=e;try{document.querySelector("div.levelItem.selected").classList.add("fadeOut")}catch(t){}setTimeout((()=>{try{document.querySelector("div.levelItem.selected").classList.remove("selected")}catch(e){}t.target.classList.add("fadeIn"),t.target.classList.add("selected")}),300);const o=t.target.classList.toString();c.switchLevel(o.match(/ez|hd|in|at/));const n=document.querySelectorAll("div.levelItem.fadeIn");for(let e=0;e<n.length;e++)n[e].classList.remove("fadeIn");const r=document.querySelectorAll("div.levelItem.fadeOut");for(let e=0;e<n.length;e++)r[e].classList.remove("fadeOut")}window.addEventListener("DOMContentLoaded",(()=>{let e=document.createElement("iframe");e.src="../loadingScreen/index.html",e.classList.add("loadingEmbedFrame"),document.body.appendChild(e);const t=[["default","默认"],["level","难度"],["name","名称"]];document.querySelector("div.settingBtn").addEventListener("click",(()=>{location.href="../settings/index.html"})),document.querySelector("div#avatarBar").addEventListener("click",(e=>{var t=e.target;null==t.classList.toString().match("avatarBar")&&(t=e.target.parentElement),t.classList.toString().match("expand")?t.classList.remove("expand"):t.classList.add("expand")})),null!=window.localStorage.getItem("playerName")&&(console.log("Setting player name: ",window.localStorage.getItem("playerName")),document.querySelector("div#avatarBar").setAttribute("data-name",window.localStorage.getItem("playerName"))),null!=window.localStorage.getItem("playerAvatar")&&(console.log("Setting player avatar: ",window.localStorage.getItem("playerAvatar")),document.querySelector("div#avatarBar").children[0].setAttribute("style",'--avatar: url("'+window.localStorage.getItem("playerAvatar")+'");')),window.chapterName=new URLSearchParams(new URL(location.href).search).get("c"),fetch("https://api.github.com/repos/heerheer/PhiCommunity-Charts-Repo/contents").then((e=>e.json())).then((o=>{window.songCodeNameList=new Array;for(let e=0;e<o.length;e++)null==o[e].name.match(/.github|README.md|CNAME|_headers/)&&window.songCodeNameList.push(o[e].name);window.songMetaList=new Array;for(let e=0;e<window.songCodeNameList.length;e++)fetch(encodeURI("https://heerheer.github.io/PhiCommunity-Charts-Repo/"+window.songCodeNameList[e]+"/meta.json")).then((e=>e.json())).then((e=>{window.songMetaList.push(e)}));const n=setInterval((()=>{if(window.songMetaList.length==window.songCodeNameList.length){const o=c.element;document.getElementsByClassName("leftArea")[0].appendChild(o);for(let e=0;e<window.songMetaList.length;e++)c.createSong(e,window.songMetaList[e],window.songMetaList[e].codename);let r=0;document.querySelector("div.sortMode").innerText=t[0][1],document.querySelector("div.sortMode").addEventListener("click",(e=>{r=(r+1)%t.length,c.setOrder(t[r][0]),e.target.innerText=t[r][1]})),window.slicesAudioContext=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext),c.switchSong(0),e.remove(),document.querySelector("#rightArea").style.setProperty("--scale",Math.round(window.devicePixelRatio)/3.5),clearInterval(n)}}),100)})).catch((()=>{alert("曲目列表获取失败！")}))})),document.querySelectorAll("div.levelItem").forEach((e=>e.addEventListener("click",a))),document.querySelector("div.playBtn").addEventListener("click",(()=>{clearInterval(window.sliceAudioInterval);try{window.sliceAudioContextSource.stop()}catch(e){}document.querySelector("#readyToLoadOverlay").classList.add("go"),fetch(i).then((e=>e.arrayBuffer())).then((e=>{const t=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);t.decodeAudioData(e,(function(e){var o=t.createBufferSource();o.buffer=e,o.loop=!1,o.connect(t.destination),o.start(0)}))})),setTimeout((()=>{window.slicesAudioContext.close(),location.href="../whilePlaying/index.html?play="+document.querySelector("div.songItem.selected").getAttribute("data-codename")+"&l="+window.levelSelected}),2e3)}))})()})();